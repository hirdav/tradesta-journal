<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeSta: Sniper Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics-compat.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 font-mono">

    <div id="loginScreen" class="fixed inset-0 bg-black z-50 flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl border border-gray-700 w-full max-w-md">
            <h1 class="text-3xl font-bold text-center text-green-500 mb-6 tracking-widest">TRADESTA</h1>
            <p class="text-center text-gray-400 mb-6 text-sm">SECURE ACCESS REQUIRED</p>
            <form id="loginForm" onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-500 mb-1">OPERATOR ID</label>
                    <input type="text" id="loginId" class="w-full bg-gray-900 text-white p-3 rounded border border-gray-600 focus:border-green-500 focus:outline-none" placeholder="Enter ID">
                </div>
                <div>
                    <label class="block text-sm text-gray-500 mb-1">PASSWORD</label>
                    <input type="password" id="loginPass" class="w-full bg-gray-900 text-white p-3 rounded border border-gray-600 focus:border-green-500 focus:outline-none" placeholder="Enter Password">
                </div>
                <p id="loginError" class="text-red-500 text-xs text-center h-4"></p>
                <button type="submit" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-3 rounded transition duration-200">AUTHENTICATE</button>
            </form>
        </div>
    </div>

    <div id="manifestoModal" class="hidden fixed inset-0 bg-black/95 z-40 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-900 border-2 border-red-900 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-[0_0_50px_rgba(220,38,38,0.3)]">
            <div class="p-6 md:p-8">
                <div class="flex justify-between items-start mb-6 border-b border-gray-800 pb-4">
                    <h2 class="text-2xl md:text-3xl font-bold text-red-500 tracking-widest uppercase">The Arena Manifesto</h2>
                    <button onclick="toggleManifesto()" class="text-gray-500 hover:text-white text-2xl font-bold">&times;</button>
                </div>
                <div class="space-y-6 text-gray-300 leading-relaxed">
                    <p class="italic text-lg text-white border-l-4 border-red-500 pl-4">"I enter this market not to gamble, but to hunt..."</p>
                    <div><h3 class="text-yellow-500 font-bold text-lg mb-1">1. MY AMMO IS SCARCE</h3><p>Two bullets. $50 each. No spray and pray.</p></div>
                    <div><h3 class="text-yellow-500 font-bold text-lg mb-1">2. MY WEAPON IS DANGEROUS</h3><p>50x leverage. Stop loss or die.</p></div>
                    <div><h3 class="text-yellow-500 font-bold text-lg mb-1">3. MY ENEMY IS THE FEE</h3><p>Limit Orders ONLY.</p></div>
                    <div class="bg-red-900/20 p-4 rounded border border-red-900/50"><h3 class="text-red-500 font-bold text-lg mb-2">5. THE PLEDGE</h3><p class="text-sm font-semibold">Market Order = Close Terminal.<br>Move Stop Loss = Close Terminal.<br>Boredom Trade = Close Terminal.</p></div>
                </div>
            </div>
        </div>
    </div>

    <div id="diaryModal" class="hidden fixed inset-0 bg-black/95 z-40 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-900 border-2 border-blue-900 rounded-lg max-w-2xl w-full max-h-[90vh] flex flex-col shadow-[0_0_50px_rgba(30,58,138,0.3)]">
            <div class="p-6 md:p-8 flex flex-col h-full">
                <div class="flex justify-between items-start mb-4 border-b border-gray-800 pb-4">
                    <h2 class="text-2xl font-bold text-blue-400 tracking-widest uppercase">Trader's Mind</h2>
                    <button onclick="toggleDiary()" class="text-gray-500 hover:text-white text-2xl font-bold">&times;</button>
                </div>
                
                <div class="mb-4">
                    <textarea id="diaryInput" rows="4" class="w-full bg-gray-800 text-white p-4 rounded border border-gray-700 focus:border-blue-500 focus:outline-none placeholder-gray-500" placeholder="Empty your mind..."></textarea>
                    
                    <div class="flex gap-2 mt-2">
                        <button id="saveDiaryBtn" onclick="saveDiary()" class="flex-1 bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition">
                            SAVE THOUGHT
                        </button>
                        <button id="cancelEditBtn" onclick="cancelEdit()" class="hidden bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition">
                            CANCEL
                        </button>
                    </div>
                </div>

                <div class="flex-grow overflow-y-auto pr-2 mb-2">
                    <h3 class="text-sm text-gray-500 mb-2 uppercase tracking-wide">Previous Thoughts</h3>
                    <div id="diaryContainer" class="space-y-3">
                        <p class="text-gray-600 text-center text-sm">Loading thoughts...</p>
                    </div>
                </div>
                
                <div id="paginationControls" class="flex justify-center items-center gap-2 mt-2 pt-2 border-t border-gray-800 text-sm hidden">
                    </div>
            </div>
        </div>
    </div>

    <div id="appContent" class="hidden container mx-auto p-4 max-w-3xl">
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center border-b border-gray-700 pb-4 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-green-500 tracking-wider">TRADESTA</h1>
                <p class="text-sm text-gray-400 mt-1">"I do not donate my edge to the exchange."</p>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleDiary()" class="bg-blue-900/30 hover:bg-blue-800 text-blue-300 border border-blue-800 px-4 py-2 rounded text-sm font-bold transition">üß† Diary</button>
                <button onclick="toggleManifesto()" class="bg-red-900/30 hover:bg-red-800 text-red-300 border border-red-800 px-4 py-2 rounded text-sm font-bold animate-pulse transition">‚ö†Ô∏è ReadMEEE</button>
                <button onclick="handleLogout()" class="text-xs text-gray-400 border border-gray-700 p-2 rounded hover:bg-gray-800 transition">LOGOUT</button>
            </div>
        </header>

        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8 border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-yellow-400">‚ö†Ô∏è PRE-FIRE CHECKLIST</h2>
            <div id="checklistForm" class="space-y-3">
                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-700 p-2 rounded transition"><input type="checkbox" id="habit1" class="w-5 h-5 text-green-500 bg-gray-700 border-gray-600"><span>Limit Order (Maker)</span></label>
                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-700 p-2 rounded transition"><input type="checkbox" id="habit2" class="w-5 h-5 text-green-500 bg-gray-700 border-gray-600"><span>Stop Loss Set</span></label>
                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-700 p-2 rounded transition"><input type="checkbox" id="habit3" class="w-5 h-5 text-green-500 bg-gray-700 border-gray-600"><span>Risk < 2%</span></label>
                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-700 p-2 rounded transition"><input type="checkbox" id="habit4" class="w-5 h-5 text-green-500 bg-gray-700 border-gray-600"><span>Calm State</span></label>
            </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8 border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-blue-400">üìù LOG THE TRADE</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <input type="text" id="pair" placeholder="BTCUSD" class="bg-gray-700 text-white p-2 rounded uppercase">
                <select id="direction" class="bg-gray-700 text-white p-2 rounded"><option value="Buy">BUY</option><option value="Sell">SELL</option></select>
                <input type="number" step="any" id="entryPrice" placeholder="Entry Price" class="bg-gray-700 text-white p-2 rounded">
                <input type="number" step="any" id="pnl" placeholder="P&L ($)" class="bg-gray-700 text-white p-2 rounded">
            </div>
            <textarea id="notes" rows="3" class="w-full bg-gray-700 text-white p-2 rounded mb-4" placeholder="Notes..."></textarea>
            <button onclick="saveTrade()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded">COMMIT</button>
        </div>

        <div class="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl font-bold mb-4 text-gray-300">üìö HISTORY</h2>
            <div id="logContainer" class="space-y-4"><p class="text-gray-500 text-center">Waiting...</p></div>
        </div>
    </div>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBZ2MFZvrw2RJhnO5wfw_gUnHCQyqjeyF4",
            authDomain: "tradesta-9ce50.firebaseapp.com",
            projectId: "tradesta-9ce50",
            storageBucket: "tradesta-9ce50.firebasestorage.app",
            messagingSenderId: "333812531676",
            appId: "1:333812531676:web:f6fd045c96ba3a47670f19",
            measurementId: "G-QM2KKPCQWE"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let diaryCache = {};        
        let editingDiaryId = null;  
        let allDiaryEntries = [];   
        let currentDiaryPage = 1;   
        const DIARY_ITEMS_PER_PAGE = 3;

        // --- AUTH ---
        function handleLogin(e) {
            e.preventDefault();
            const id = document.getElementById('loginId').value;
            const pass = document.getElementById('loginPass').value;
            if (id === "D_8op!%") {
                auth.signInWithEmailAndPassword("admin@tradesta.com", pass)
                    .catch(err => document.getElementById('loginError').innerText = "ACCESS DENIED");
            } else { document.getElementById('loginError').innerText = "INVALID OPERATOR ID"; }
        }
        function handleLogout() { auth.signOut(); }
        
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appContent').classList.remove('hidden');
                loadTrades();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('appContent').classList.add('hidden');
            }
        });

        // --- UI TOGGLES ---
        function toggleManifesto() { document.getElementById('manifestoModal').classList.toggle('hidden'); }
        function toggleDiary() {
            const modal = document.getElementById('diaryModal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) {
                loadDiary();
                document.getElementById('diaryInput').focus();
            }
        }

        // --- DIARY LOGIC ---
        function saveDiary() {
            const content = document.getElementById('diaryInput').value;
            if (!content.trim()) return;

            const btn = document.getElementById('saveDiaryBtn');
            btn.innerText = "SAVING...";
            btn.disabled = true;

            const promise = editingDiaryId 
                ? db.collection("diary_entries").doc(editingDiaryId).update({
                    content: content,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                })
                : db.collection("diary_entries").add({
                    content: content,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    uid: auth.currentUser.uid
                });

            promise.then(() => {
                resetDiaryForm();
                loadDiary(); 
            }).catch(err => {
                alert("Error: " + err.message);
                resetDiaryForm();
            });
        }

        function startEdit(id) {
            const entry = diaryCache[id];
            if (!entry) return;
            editingDiaryId = id;
            document.getElementById('diaryInput').value = entry.content;
            const btn = document.getElementById('saveDiaryBtn');
            btn.innerText = "UPDATE THOUGHT";
            btn.classList.replace('bg-blue-700', 'bg-green-700');
            btn.classList.replace('hover:bg-blue-600', 'hover:bg-green-600');
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            document.getElementById('diaryInput').focus();
        }

        function cancelEdit() { resetDiaryForm(); }

        function resetDiaryForm() {
            editingDiaryId = null;
            document.getElementById('diaryInput').value = '';
            const btn = document.getElementById('saveDiaryBtn');
            btn.innerText = "SAVE THOUGHT";
            btn.disabled = false;
            btn.classList.replace('bg-green-700', 'bg-blue-700');
            btn.classList.replace('hover:bg-green-600', 'hover:bg-blue-600');
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        // --- PAGINATION & LOADING ---
        function loadDiary() {
            const container = document.getElementById('diaryContainer');
            db.collection("diary_entries").orderBy("timestamp", "desc").limit(50).get()
            .then((snapshot) => {
                allDiaryEntries = [];
                diaryCache = {};

                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-600 text-center text-sm">No thoughts recorded.</p>';
                    document.getElementById('paginationControls').classList.add('hidden');
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    diaryCache[doc.id] = data; 
                    allDiaryEntries.push({ id: doc.id, ...data });
                });

                currentDiaryPage = 1;
                renderDiaryPage();
            });
        }

        function renderDiaryPage() {
            const container = document.getElementById('diaryContainer');
            container.innerHTML = '';

            const startIndex = (currentDiaryPage - 1) * DIARY_ITEMS_PER_PAGE;
            const endIndex = startIndex + DIARY_ITEMS_PER_PAGE;
            const pageItems = allDiaryEntries.slice(startIndex, endIndex);

            pageItems.forEach(item => {
                const date = item.timestamp ? item.timestamp.toDate().toLocaleString() : 'Just now';
                const html = `
                    <div class="bg-gray-800 p-3 rounded border border-gray-700 text-sm group relative animate-fade-in">
                        <div class="flex justify-between items-start mb-1">
                            <div class="text-xs text-blue-400">${date}</div>
                            <button onclick="startEdit('${item.id}')" class="text-xs font-bold text-gray-400 hover:text-white bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded transition">
                                ‚úèÔ∏è Edit
                            </button>
                        </div>
                        <div class="text-gray-300 whitespace-pre-wrap">${item.content}</div>
                    </div>
                `;
                container.innerHTML += html;
            });

            renderPaginationControls();
        }

        function renderPaginationControls() {
            const controls = document.getElementById('paginationControls');
            const totalPages = Math.ceil(allDiaryEntries.length / DIARY_ITEMS_PER_PAGE);

            if (totalPages <= 1) {
                controls.classList.add('hidden');
                return;
            }

            controls.classList.remove('hidden');
            let html = '';

            if (currentDiaryPage > 1) {
                html += `<button onclick="changePage(${currentDiaryPage - 1})" class="px-2 py-1 bg-gray-800 hover:bg-gray-700 rounded text-xs">Prev</button>`;
            } else {
                html += `<button class="px-2 py-1 bg-gray-900 text-gray-600 rounded text-xs cursor-not-allowed">Prev</button>`;
            }

            const range = [];
            const delta = 1;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentDiaryPage - delta && i <= currentDiaryPage + delta)) {
                    range.push(i);
                }
            }

            let lastItem = null;
            range.forEach(i => {
                if (lastItem) {
                    if (i - lastItem === 2) {
                        html += generatePageBtn(lastItem + 1, false);
                    } else if (i - lastItem > 1) {
                        html += `<span class="px-2 text-gray-600">...</span>`;
                    }
                }
                html += generatePageBtn(i, i === currentDiaryPage);
                lastItem = i;
            });

            if (currentDiaryPage < totalPages) {
                html += `<button onclick="changePage(${currentDiaryPage + 1})" class="px-2 py-1 bg-gray-800 hover:bg-gray-700 rounded text-xs">Next</button>`;
            } else {
                html += `<button class="px-2 py-1 bg-gray-900 text-gray-600 rounded text-xs cursor-not-allowed">Next</button>`;
            }

            controls.innerHTML = html;
        }

        function generatePageBtn(pageNum, isActive) {
            const activeClass = isActive ? "bg-blue-700 text-white" : "bg-gray-800 hover:bg-gray-700 text-gray-300";
            return `<button onclick="changePage(${pageNum})" class="px-3 py-1 rounded text-xs mx-1 ${activeClass}">${pageNum}</button>`;
        }

        function changePage(pageNum) {
            currentDiaryPage = pageNum;
            renderDiaryPage();
        }

        // --- TRADES LOGIC ---
        function saveTrade() {
            const habits = {
                limitOrder: document.getElementById('habit1').checked,
                stopLoss: document.getElementById('habit2').checked,
                riskMgmt: document.getElementById('habit3').checked,
                calmState: document.getElementById('habit4').checked
            };
            const tradeData = {
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                pair: document.getElementById('pair').value.toUpperCase(),
                direction: document.getElementById('direction').value,
                entryPrice: parseFloat(document.getElementById('entryPrice').value),
                pnl: parseFloat(document.getElementById('pnl').value) || 0,
                notes: document.getElementById('notes').value,
                habits: habits,
                uid: auth.currentUser.uid 
            };
            if (!tradeData.pair || !tradeData.entryPrice) { alert("Fill in Pair and Price."); return; }

            db.collection("trades").add(tradeData).then(() => {
                document.getElementById('pair').value = ''; document.getElementById('entryPrice').value = '';
                document.getElementById('pnl').value = ''; document.getElementById('notes').value = '';
                document.querySelectorAll('input[type=checkbox]').forEach(el => el.checked = false);
                alert("Trade Logged."); loadTrades();
            }).catch(e => alert(e.message));
        }

        function loadTrades() {
            const container = document.getElementById('logContainer');
            db.collection("trades").orderBy("timestamp", "desc").limit(20).get().then((snapshot) => {
                container.innerHTML = '';
                if (snapshot.empty) { container.innerHTML = '<p class="text-gray-500 text-center">No trades found.</p>'; return; }
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.timestamp ? data.timestamp.toDate().toLocaleString() : '...';
                    
                    // Style Helpers
                    const pnlClass = data.pnl > 0 ? 'text-green-400' : (data.pnl < 0 ? 'text-red-400' : 'text-gray-400');
                    const pnlSign = data.pnl > 0 ? '+' : '';
                    
                    const isLong = data.direction === 'Long';
                    const dirColor = isLong ? 'text-green-400' : 'text-red-400';
                    const dirBg = isLong ? 'bg-green-900/20 border-green-800' : 'bg-red-900/20 border-red-800';
                    const dirArrow = isLong ? '‚Üë' : '‚Üì';
                    const dirText = isLong ? 'LONG' : 'SHORT';

                    const allHabits = data.habits && data.habits.limitOrder && data.habits.stopLoss && data.habits.riskMgmt && data.habits.calmState;
                    const badge = allHabits 
                        ? '<span class="text-[10px] bg-green-900/50 text-green-300 px-1.5 py-0.5 rounded border border-green-700/50 tracking-wider">DISCIPLINED</span>' 
                        : '<span class="text-[10px] bg-red-900/50 text-red-300 px-1.5 py-0.5 rounded border border-red-700/50 tracking-wider">UNDISCIPLINED</span>';

                    container.innerHTML += `
                        <div class="border-b border-gray-700 pb-4 mb-4 last:border-0 last:mb-0 last:pb-0 hover:bg-gray-800/50 transition p-3 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-3">
                                    <span class="font-black text-xl text-gray-100 tracking-wider">${data.pair}</span>
                                    <span class="text-xs font-bold px-2 py-1 rounded border ${dirBg} ${dirColor} flex items-center gap-1">
                                        ${dirArrow} ${dirText}
                                    </span>
                                </div>
                                <div class="text-xs text-gray-500">${date}</div>
                            </div>
                            <div class="flex justify-between items-end bg-gray-900/50 p-2 rounded border border-gray-700/30">
                                <div>
                                    <div class="text-xs text-gray-500 uppercase tracking-wide mb-0.5">Entry Price</div>
                                    <div class="font-mono text-white text-lg">$${data.entryPrice}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-xs text-gray-500 uppercase tracking-wide mb-0.5">Outcome</div>
                                    <div class="font-bold font-mono text-xl ${pnlClass}">${pnlSign}$${data.pnl}</div>
                                </div>
                            </div>
                            <div class="mt-3 flex justify-between items-start gap-4">
                                <div class="text-gray-400 text-sm italic leading-relaxed flex-1 opacity-80">
                                    ${data.notes ? `"${data.notes}"` : '<span class="opacity-30">No notes recorded.</span>'}
                                </div>
                                <div class="shrink-0 pt-1">
                                    ${badge}
                                </div>
                            </div>
                        </div>`;
                });
            });
        }
    </script>
</body>
</html>

